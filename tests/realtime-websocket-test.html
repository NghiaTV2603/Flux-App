<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flux Realtime WebSocket Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #1e1e1e;
        color: #fff;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      .panel {
        background: #2d2d2d;
        border-radius: 8px;
        padding: 20px;
      }
      .controls {
        margin-bottom: 20px;
      }
      input,
      button,
      select {
        padding: 8px 12px;
        margin: 5px;
        border: 1px solid #555;
        border-radius: 4px;
        background: #3d3d3d;
        color: #fff;
      }
      button {
        background: #4caf50;
        cursor: pointer;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
      }
      #messages {
        height: 400px;
        overflow-y: auto;
        background: #1a1a1a;
        border: 1px solid #555;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .message {
        margin: 5px 0;
        padding: 5px;
        border-radius: 4px;
      }
      .message.sent {
        background: #0084ff;
        text-align: right;
      }
      .message.received {
        background: #444;
      }
      .message.system {
        background: #ff6b35;
        font-style: italic;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .status.connected {
        background: #4caf50;
      }
      .status.disconnected {
        background: #f44336;
      }
      .typing {
        color: #888;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>ðŸš€ Flux Realtime Service Test</h1>

    <div class="container">
      <!-- Connection Panel -->
      <div class="panel">
        <h3>Connection</h3>
        <div class="controls">
          <input
            type="text"
            id="userId"
            placeholder="User ID"
            value="user123"
          />
          <input
            type="text"
            id="serverUrl"
            placeholder="WebSocket URL"
            value="ws://localhost:3006/realtime"
          />
          <br />
          <button id="connectBtn" onclick="connect()">Connect</button>
          <button id="disconnectBtn" onclick="disconnect()" disabled>
            Disconnect
          </button>
        </div>
        <div id="connectionStatus" class="status disconnected">
          Disconnected
        </div>
      </div>

      <!-- Channel Panel -->
      <div class="panel">
        <h3>Channel Management</h3>
        <div class="controls">
          <input
            type="text"
            id="channelId"
            placeholder="Channel ID"
            value="channel123"
          />
          <input
            type="text"
            id="serverId"
            placeholder="Server ID"
            value="server123"
          />
          <br />
          <button onclick="joinChannel()" disabled id="joinChannelBtn">
            Join Channel
          </button>
          <button onclick="leaveChannel()" disabled id="leaveChannelBtn">
            Leave Channel
          </button>
        </div>
      </div>
    </div>

    <!-- Messages Panel -->
    <div class="panel">
      <h3>Messages</h3>
      <div id="messages"></div>
      <div class="controls">
        <input
          type="text"
          id="messageInput"
          placeholder="Type a message..."
          disabled
        />
        <button onclick="sendMessage()" disabled id="sendBtn">
          Send Message
        </button>
        <button onclick="startTyping()" disabled id="typingBtn">
          Start Typing
        </button>
        <button onclick="stopTyping()" disabled id="stopTypingBtn">
          Stop Typing
        </button>
      </div>
      <div id="typingIndicators" class="typing"></div>
    </div>

    <!-- Presence Panel -->
    <div class="panel">
      <h3>Presence & Status</h3>
      <div class="controls">
        <select id="statusSelect" disabled>
          <option value="online">Online</option>
          <option value="away">Away</option>
          <option value="busy">Busy</option>
          <option value="offline">Offline</option>
        </select>
        <input
          type="text"
          id="customStatus"
          placeholder="Custom status..."
          disabled
        />
        <button onclick="updatePresence()" disabled id="updatePresenceBtn">
          Update Presence
        </button>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      let socket = null;
      let currentChannelId = null;
      let userId = null;

      function addMessage(message, type = "received") {
        const messages = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `
                <small>${new Date().toLocaleTimeString()}</small><br>
                ${message}
            `;
        messages.appendChild(messageDiv);
        messages.scrollTop = messages.scrollHeight;
      }

      function updateConnectionStatus(connected) {
        const status = document.getElementById("connectionStatus");
        const buttons = document.querySelectorAll("button");

        if (connected) {
          status.className = "status connected";
          status.textContent = "Connected";
          document.getElementById("connectBtn").disabled = true;
          document.getElementById("disconnectBtn").disabled = false;

          // Enable other buttons
          document
            .querySelectorAll("button:not(#connectBtn)")
            .forEach((btn) => {
              btn.disabled = false;
            });
          document.querySelectorAll("input, select").forEach((input) => {
            input.disabled = false;
          });
        } else {
          status.className = "status disconnected";
          status.textContent = "Disconnected";
          document.getElementById("connectBtn").disabled = false;
          document.getElementById("disconnectBtn").disabled = true;

          // Disable other buttons
          document
            .querySelectorAll("button:not(#connectBtn)")
            .forEach((btn) => {
              btn.disabled = true;
            });
          document.querySelectorAll("input, select").forEach((input) => {
            input.disabled = true;
          });
          document.getElementById("userId").disabled = false;
          document.getElementById("serverUrl").disabled = false;
        }
      }

      function connect() {
        userId = document.getElementById("userId").value;
        const serverUrl = document.getElementById("serverUrl").value;

        if (!userId) {
          alert("Please enter a User ID");
          return;
        }

        socket = io(serverUrl, {
          auth: {
            token: "test-token",
          },
          query: {
            userId: userId,
          },
        });

        socket.on("connect", () => {
          updateConnectionStatus(true);
          addMessage(`Connected as ${userId}`, "system");
        });

        socket.on("disconnect", () => {
          updateConnectionStatus(false);
          addMessage("Disconnected from server", "system");
        });

        socket.on("connected", (data) => {
          addMessage(`Welcome! Socket ID: ${data.socketId}`, "system");
        });

        // Message events
        socket.on("message:new", (data) => {
          addMessage(
            `[${data.channelId}] ${data.authorId}: ${data.content}`,
            "received"
          );
        });

        socket.on("message:updated", (data) => {
          addMessage(
            `[${data.channelId}] Message updated: ${data.content} (edited)`,
            "system"
          );
        });

        socket.on("message:deleted", (data) => {
          addMessage(`[${data.channelId}] Message deleted`, "system");
        });

        // Channel events
        socket.on("channel_joined", (data) => {
          addMessage(`Joined channel: ${data.channelId}`, "system");
          currentChannelId = data.channelId;
        });

        socket.on("channel_left", (data) => {
          addMessage(`Left channel: ${data.channelId}`, "system");
          currentChannelId = null;
        });

        socket.on("user_joined_channel", (data) => {
          addMessage(
            `User ${data.userId} joined channel ${data.channelId}`,
            "system"
          );
        });

        socket.on("user_left_channel", (data) => {
          addMessage(
            `User ${data.userId} left channel ${data.channelId}`,
            "system"
          );
        });

        // Typing events
        socket.on("typing_start", (data) => {
          updateTypingIndicator(data.userId, true);
        });

        socket.on("typing_stop", (data) => {
          updateTypingIndicator(data.userId, false);
        });

        // Presence events
        socket.on("presence_update", (data) => {
          addMessage(`User ${data.userId} is now ${data.status}`, "system");
        });

        // Reaction events
        socket.on("reaction:update", (data) => {
          addMessage(
            `Reaction ${data.type}: ${data.emoji} by ${data.userId}`,
            "system"
          );
        });

        // DM events
        socket.on("dm:new", (data) => {
          addMessage(`DM from ${data.senderId}: ${data.content}`, "received");
        });

        socket.on("error", (data) => {
          addMessage(`Error: ${data.message}`, "system");
        });
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
          updateConnectionStatus(false);
        }
      }

      function joinChannel() {
        const channelId = document.getElementById("channelId").value;
        const serverId = document.getElementById("serverId").value;

        if (!channelId || !serverId) {
          alert("Please enter Channel ID and Server ID");
          return;
        }

        socket.emit("join_channel", { channelId, serverId });
      }

      function leaveChannel() {
        if (!currentChannelId) {
          alert("Not in any channel");
          return;
        }

        socket.emit("leave_channel", { channelId: currentChannelId });
      }

      function sendMessage() {
        const message = document.getElementById("messageInput").value;
        if (!message || !currentChannelId) {
          alert("Please join a channel and enter a message");
          return;
        }

        // Simulate sending message (in real app, this would go through Message Service)
        addMessage(`You: ${message}`, "sent");
        document.getElementById("messageInput").value = "";
      }

      function startTyping() {
        if (!currentChannelId) {
          alert("Please join a channel first");
          return;
        }

        socket.emit("typing_start", { channelId: currentChannelId });
      }

      function stopTyping() {
        if (!currentChannelId) {
          alert("Please join a channel first");
          return;
        }

        socket.emit("typing_stop", { channelId: currentChannelId });
      }

      function updatePresence() {
        const status = document.getElementById("statusSelect").value;
        const customStatus = document.getElementById("customStatus").value;

        socket.emit("update_presence", { status, customStatus });
      }

      function updateTypingIndicator(userId, isTyping) {
        const indicators = document.getElementById("typingIndicators");
        const indicatorId = `typing-${userId}`;
        let indicator = document.getElementById(indicatorId);

        if (isTyping) {
          if (!indicator) {
            indicator = document.createElement("div");
            indicator.id = indicatorId;
            indicators.appendChild(indicator);
          }
          indicator.textContent = `${userId} is typing...`;
        } else {
          if (indicator) {
            indicator.remove();
          }
        }
      }

      // Allow sending message with Enter key
      document
        .getElementById("messageInput")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Initialize
      updateConnectionStatus(false);
    </script>
  </body>
</html>
